---
import SEOHead from '../components/SEOHead.astro';
import '../styles/global.css';

export interface Props {
  title: string;
  description: string;
  canonical?: string;
  image?: string;
  keywords?: string;
  schema?: object | object[];
}

const { title, description, canonical, image, keywords, schema } = Astro.props;
const GA4_ID = import.meta.env.PUBLIC_GA4_ID || 'G-XXXXXXXXXX';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <SEOHead
      title={title}
      description={description}
      canonical={canonical}
      image={image}
      keywords={keywords}
      schema={schema}
    />
    
    <!-- Preload Hero Image for main page -->
    <link rel="preload" href="/assets/images/hero.webp" as="image" fetchpriority="high" />
    
    <slot name="head" />
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <slot />

    <!-- Scroll to Top Button -->
    <a href="#home" aria-label="Scroll to top of page" class="fas fa-angle-up" id="scroll-top"></a>

    <!-- Google Analytics -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`}></script>
    <script define:vars={{ GA4_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', GA4_ID);

      // Enhanced Event Tracking
      document.addEventListener('DOMContentLoaded', function() {
        // Track project view clicks
        document.querySelectorAll('.work .box .btn, .work .btns .btn').forEach(function(link) {
          link.addEventListener('click', function() {
            var projectBox = this.closest('.box') || this.closest('.grid-item');
            var projectName = projectBox ? (projectBox.querySelector('h3') || {}).textContent || 'Unknown' : 'Unknown';
            var isView = this.textContent.trim().toLowerCase().includes('view');
            gtag('event', isView ? 'view_project' : 'view_code', {
              'event_category': 'Project Interaction',
              'event_label': projectName,
              'project_name': projectName
            });
          });
        });

        // Track contact form submissions
        var contactForm = document.querySelector('.contact form, #contact-form');
        if (contactForm) {
          contactForm.addEventListener('submit', function() {
            gtag('event', 'contact_form_submit', {
              'event_category': 'Contact',
              'event_label': 'Homepage Contact Form'
            });
          });
        }

        // Track resume downloads
        document.querySelectorAll('a[href*="drive.google.com"]').forEach(function(link) {
          link.addEventListener('click', function() {
            gtag('event', 'resume_download', {
              'event_category': 'Resume',
              'event_label': 'Resume PDF Download'
            });
          });
        });

        // Track external link clicks
        document.querySelectorAll('a[target="_blank"]').forEach(function(link) {
          link.addEventListener('click', function() {
            gtag('event', 'click', {
              'event_category': 'External Link',
              'event_label': this.href
            });
          });
        });

        // Track social link clicks
        document.querySelectorAll('.share a, .linkedin a, .github a, .twitter a').forEach(function(link) {
          link.addEventListener('click', function() {
            var platform = this.getAttribute('aria-label') || 'Unknown';
            gtag('event', 'social_click', {
              'event_category': 'Social Media',
              'event_label': platform
            });
          });
        });
      });
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('ServiceWorker registered:', registration.scope);
            })
            .catch(error => {
              console.log('ServiceWorker registration failed:', error);
            });
        });
      }
    </script>

    <!-- Scroll Top Button Script -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const scrollTop = document.getElementById('scroll-top');
        
        window.addEventListener('scroll', () => {
          if (window.scrollY > 60) {
            scrollTop?.classList.add('active');
          } else {
            scrollTop?.classList.remove('active');
          }
        });
      });

      // Visibility change handler
      document.addEventListener('visibilitychange', function () {
        const favicon = document.getElementById('favicon') as HTMLLinkElement;
        if (document.visibilityState === 'visible') {
          document.title = 'Portfolio | Shariar Nehal';
          if (favicon) favicon.href = '/assets/images/Favicon.webp';
        } else {
          document.title = 'Come Back To Portfolio';
          if (favicon) favicon.href = '/assets/images/favhand.png';
        }
      });
    </script>

    <slot name="scripts" />
  </body>
</html>
