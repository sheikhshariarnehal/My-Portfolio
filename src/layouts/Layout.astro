---
import SEOHead from '../components/SEOHead.astro';
import '../styles/global.css';

export interface Props {
  title: string;
  description: string;
  canonical?: string;
  image?: string;
  keywords?: string;
  schema?: object | object[];
}

const { title, description, canonical, image, keywords, schema } = Astro.props;
const GA4_ID = import.meta.env.PUBLIC_GA4_ID || 'G-XXXXXXXXXX';
const isHomePage = Astro.url.pathname === '/' || Astro.url.pathname === '';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <SEOHead
      title={title}
      description={description}
      canonical={canonical}
      image={image}
      keywords={keywords}
      schema={schema}
    />
    
    <!-- Preload Hero Image only on homepage -->
    {isHomePage && <link rel="preload" href="/assets/images/hero.webp" as="image" fetchpriority="high" />}
    
    <!-- Critical CSS - inlined for faster FCP -->
    <style is:inline>
      html{font-size:62.5%;overflow-x:hidden}body{background:#f7f7f7;font-family:"Poppins","Poppins-fallback",sans-serif;margin:0}*{margin:0;padding:0;box-sizing:border-box;text-decoration:none;border:none;outline:none;text-transform:capitalize}header{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;align-items:center;justify-content:between;height:6.5rem;background:#fff;padding:1.7rem 10%;box-shadow:0 1px 4px rgba(146,161,176,.3)}header .logo{font-weight:800;font-size:1.9rem;color:#0e2431;text-decoration:none}header .logo i{font-size:2.2rem}header .navbar ul{list-style:none;display:flex;justify-content:center;align-items:center}header .navbar li{margin-left:2.5rem}header .navbar ul li a{font-weight:600;text-decoration:none;font-size:1.57rem;color:#0e2431;letter-spacing:.04rem}section{min-height:100vh;padding:2rem 9%}.home{position:relative;display:flex;flex-wrap:wrap;gap:1.5rem;min-height:100vh;align-items:center}.home .content{z-index:1;padding-top:1rem;flex:1 1 40rem}.home .image{z-index:1;flex:1 1 40rem}.home .image img{border-radius:50%;cursor:pointer;margin:0 auto;width:400px;max-width:100%;aspect-ratio:1/1;box-shadow:0 2px 8px rgba(0,0,0,.3);object-fit:cover}.home .content h1{font-weight:800;color:#002057;font-size:5rem}.home .content h1 span{font-weight:800;color:#ff7b00;font-size:5rem}.home .content p{font-weight:600;color:#000;padding:1rem 0;font-size:2.5rem;min-height:4.5rem}.home .btn{margin-top:2rem;display:inline-block;position:relative;color:#fff;line-height:1;padding:1.5rem 3rem;border-radius:4em;background:#2506ad;box-shadow:0 5px 18px rgba(48,68,247,.6);font-family:"Nunito",sans-serif;text-decoration:none;text-transform:capitalize}.home .btn span{font-weight:700;font-size:1.7rem;letter-spacing:.1rem}
      /* Font fallbacks */
      @font-face{font-family:'Poppins-fallback';src:local('Arial');size-adjust:105%;ascent-override:105%;descent-override:35%;line-gap-override:10%}
      @font-face{font-family:'Nunito-fallback';src:local('Arial');size-adjust:101%;ascent-override:100%;descent-override:35%;line-gap-override:0%}
      /* Loader */
      .loader-container{position:fixed;top:0;left:0;z-index:10000;background:#e6eff1;display:flex;align-items:center;justify-content:center;height:100%;width:100%}.loader-container.fade-out{opacity:0;visibility:hidden}.loader-spinner{width:50px;height:50px;border-radius:50%;animation:spin 1s linear infinite;border:4px solid #e0e0e0;border-top-color:#2b3dda}@keyframes spin{to{transform:rotate(360deg)}}
      /* Skip link */
      .skip-link{position:absolute;left:50%;transform:translateX(-50%);padding:1rem 2rem;background:#2b3dda;color:#fff;text-decoration:none;font-weight:600;z-index:10000;top:-100%;font-size:1.6rem;border-radius:0 0 8px 8px}.skip-link:focus{top:0}
      /* Hamburger hidden desktop */
      #menu{cursor:pointer;display:none;font-size:3rem;color:rgb(24,2,63)}
      @media(max-width:768px){#menu{display:block}header .navbar{position:fixed;width:75%;height:100%;text-align:left;background:#0e0f31;top:6.5rem;right:-120%}header .navbar ul{flex-direction:column;padding:1rem}header .navbar.nav-toggle{right:0}}
    </style>

    <slot name="head" />
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <slot />

    <!-- Scroll to Top Button -->
    <a href="#home" aria-label="Scroll to top of page" class="fas fa-angle-up" id="scroll-top"></a>

    <!-- Google Analytics - Deferred until user interaction for better performance -->
    <script define:vars={{ GA4_ID }}>
      // Defer GA4 loading to avoid blocking main thread
      let gaLoaded = false;
      function loadGA() {
        if (gaLoaded) return;
        gaLoaded = true;
        var s = document.createElement('script');
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA4_ID;
        s.async = true;
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', GA4_ID, { send_page_view: true });

        // Enhanced Event Tracking
        setupEventTracking();
      }

      function setupEventTracking() {
        // Track project view clicks
        document.querySelectorAll('.work .box .btn, .work .btns .btn').forEach(function(link) {
          link.addEventListener('click', function() {
            var projectBox = this.closest('.box') || this.closest('.grid-item');
            var projectName = projectBox ? (projectBox.querySelector('h3') || {}).textContent || 'Unknown' : 'Unknown';
            var isView = this.textContent.trim().toLowerCase().includes('view');
            window.gtag('event', isView ? 'view_project' : 'view_code', {
              'event_category': 'Project Interaction',
              'event_label': projectName
            });
          });
        });

        // Track contact form submissions
        var contactForm = document.querySelector('.contact form, #contact-form');
        if (contactForm) {
          contactForm.addEventListener('submit', function() {
            window.gtag('event', 'contact_form_submit', {
              'event_category': 'Contact',
              'event_label': 'Homepage Contact Form'
            });
          });
        }

        // Track resume downloads
        document.querySelectorAll('a[href*="drive.google.com"]').forEach(function(link) {
          link.addEventListener('click', function() {
            window.gtag('event', 'resume_download', { 'event_category': 'Resume' });
          });
        });

        // Track external link clicks
        document.querySelectorAll('a[target="_blank"]').forEach(function(link) {
          link.addEventListener('click', function() {
            window.gtag('event', 'click', {
              'event_category': 'External Link',
              'event_label': this.href
            });
          });
        });
      }

      // Load GA on first user interaction or after 4 seconds
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGA, { timeout: 4000 });
      } else {
        setTimeout(loadGA, 4000);
      }
      ['scroll', 'click', 'touchstart', 'keydown'].forEach(function(evt) {
        document.addEventListener(evt, loadGA, { once: true, passive: true });
      });
    </script>

    <!-- Service Worker Registration - Deferred -->
    <script>
      if ('serviceWorker' in navigator) {
        // Defer SW registration to avoid competing with critical resources
        if ('requestIdleCallback' in window) {
          requestIdleCallback(() => {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
          });
        } else {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
          });
        }
      }
    </script>

    <!-- Scroll Top Button Script -->
    <script>
      const scrollTop = document.getElementById('scroll-top');
      if (scrollTop) {
        let stTicking = false;
        window.addEventListener('scroll', () => {
          if (!stTicking) {
            requestAnimationFrame(() => {
              scrollTop.classList.toggle('active', window.scrollY > 60);
              stTicking = false;
            });
            stTicking = true;
          }
        }, { passive: true });
      }

      // Visibility change handler - only change favicon, preserve page title for SEO
      document.addEventListener('visibilitychange', function () {
        const favicon = document.getElementById('favicon') as HTMLLinkElement;
        if (document.visibilityState === 'visible') {
          if (favicon) favicon.href = '/assets/images/Favicon.webp';
        } else {
          if (favicon) favicon.href = '/assets/images/favhand.png';
        }
      });
    </script>

    <slot name="scripts" />
  </body>
</html>
