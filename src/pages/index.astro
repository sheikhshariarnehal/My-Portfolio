---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SkillCard from '../components/SkillCard.astro';
import EducationCard from '../components/EducationCard.astro';
import TimelineItem from '../components/TimelineItem.astro';
import SocialIcons from '../components/SocialIcons.astro';
import ContactForm from '../components/ContactForm.astro';
import { Image } from 'astro:assets';
import { getEducation, getExperience, getHomepageSettings } from '../lib/supabase';
import { getOrganizationSchema, getFAQSchema, getLocalBusinessSchema, defaultFAQs } from '../lib/seo-utils';

import skills from '../data/skills.json';
import projects from '../data/projects.json';

// Fetch homepage settings from database
const homepageSettings = await getHomepageSettings();
const heroData = homepageSettings.hero || {};
const aboutData = homepageSettings.about || {};
const contactData = homepageSettings.contact || {};
const seoData = homepageSettings.seo || {};

// Default values as fallback
const hero = {
  greeting: heroData.greeting || "Hi There,",
  name: heroData.name || "Sheikh Shariar Nehal",
  subtitle: heroData.subtitle || "I Am Into",
  typingTexts: heroData.typingTexts || ['frontend development', 'backend development', 'web designing', 'android development', 'web development'],
  heroImage: heroData.heroImage || "/assets/images/hero.webp",
  heroImageAlt: heroData.heroImageAlt || "Sheikh Shariar Nehal - Full Stack Web Developer",
  ctaText: heroData.ctaText || "About Me",
  ctaLink: heroData.ctaLink || "#about"
};

const about = {
  title: aboutData.title || "I'm Sheikh Shariar Nehal",
  subtitle: aboutData.subtitle || "Web Developer",
  profileImage: aboutData.profileImage || "/assets/images/profile2.webp",
  profileImageAlt: aboutData.profileImageAlt || "Sheikh Shariar Nehal Profile Picture - Web Developer and Designer",
  bio: aboutData.bio || "I'm a Web Developer and programmer with 3 years of experience.",
  email: aboutData.email || "nehal22205101260@diu.edu.bd",
  location: aboutData.location || "Nowabgonj, Dhaka",
  resumeText: aboutData.resumeText || "Resume",
  resumeUrl: aboutData.resumeUrl || "#"
};

const contact = {
  contactImage: contactData.contactImage || "/assets/images/contact1.webp",
  contactImageAlt: contactData.contactImageAlt || "Contact Sheikh Shariar Nehal - Get In Touch"
};

// Fetch education from database
const educationData = await getEducation();
const education = educationData.map(edu => ({
  degree: edu.degree,
  institution: edu.institution,
  image: edu.image || '/assets/images/educat/default.webp',
  duration: `${edu.start_year}-${edu.end_year || 'Present'}`,
  status: edu.status || 'Completed',
  altText: `${edu.institution} - ${edu.degree}`
}));

// Filter projects for home page (exclude android, limit to 6 for better performance)
const homeProjects = projects.filter(p => p.category !== 'android').slice(0, 6);

// Fetch experience from database
const experienceData = await getExperience();
const homeExperience = experienceData.map((exp, index) => {
  const startDate = new Date(exp.start_date);
  const endDate = exp.end_date ? new Date(exp.end_date) : null;
  const startStr = startDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  const endStr = endDate ? endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'Present';
  
  return {
    organization: exp.company,
    role: exp.title,
    duration: `${startStr} - ${endStr}`,
    position: (index % 2 === 0 ? 'left' : 'right') as 'left' | 'right'
  };
});

// Schema.org JSON-LD - Enhanced Person Schema (using database values or defaults)
const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "https://sheikhshariarnehal.me/#person",
  "name": seoData.name || "Sheikh Shariar Nehal",
  "alternateName": ["Shariar Nehal", "Sheikh Nehal", "Nehal"],
  "url": "https://sheikhshariarnehal.me",
  "image": {
    "@type": "ImageObject",
    "url": about.profileImage.startsWith('http') ? about.profileImage : `https://sheikhshariarnehal.me${about.profileImage}`,
    "width": 400,
    "height": 400
  },
  "jobTitle": seoData.jobTitle || "Full-Stack Web Developer & Designer",
  "description": seoData.description || "Sheikh Shariar Nehal is a Full-Stack Web Developer with 3+ years of experience.",
  "email": seoData.email || about.email,
  "telephone": seoData.telephone || "+8801750627421",
  "nationality": {
    "@type": "Country",
    "name": seoData.nationality || "Bangladesh"
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": seoData.addressLocality || "Nowabgonj",
    "addressRegion": seoData.addressRegion || "Dhaka",
    "addressCountry": seoData.addressCountry || "BD"
  },
  "alumniOf": {
    "@type": "EducationalOrganization",
    "name": seoData.university || "Daffodil International University",
    "url": seoData.universityUrl || "https://daffodilvarsity.edu.bd"
  },
  "knowsAbout": [
    "React.js", "Next.js", "Node.js", "TypeScript", "JavaScript", "Python",
    "MERN Stack", "Full Stack Development", "Machine Learning", "Web Design",
    "REST APIs", "PostgreSQL", "MongoDB", "Supabase", "Firebase"
  ],
  "knowsLanguage": ["en", "bn"],
  "worksFor": {
    "@type": "Organization",
    "name": "Freelance"
  },
  "sameAs": [
    seoData.github || "https://github.com/sheikhshariarnehal",
    seoData.linkedin || "https://www.linkedin.com/in/shekhshariarnehal/",
    seoData.twitter || "https://twitter.com/shariar_nehal",
    seoData.telegram || "https://t.me/sheikhshariarnehal",
    seoData.instagram || "https://instagram.com/sheikhshariarnehal",
    seoData.facebook || "https://www.facebook.com/sheikhshariarnehal.cse"
  ].filter(Boolean)
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Sheikh Shariar Nehal Portfolio",
  "url": "https://sheikhshariarnehal.me",
  "description": "Portfolio website of Sheikh Shariar Nehal showcasing web development projects, skills, and professional experience"
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://sheikhshariarnehal.me/" },
    { "@type": "ListItem", "position": 2, "name": "Projects", "item": "https://sheikhshariarnehal.me/projects/" },
    { "@type": "ListItem", "position": 3, "name": "Experience", "item": "https://sheikhshariarnehal.me/experience/" }
  ]
};

// Additional SEO Schemas
const organizationSchema = getOrganizationSchema();
const faqSchema = getFAQSchema(defaultFAQs);
const localBusinessSchema = getLocalBusinessSchema();
---

<Layout
  title="Sheikh Shariar Nehal | Shariar Nehal - Full-Stack Web Developer & Designer"
  description="Sheikh Shariar Nehal (Shariar Nehal) – Expert Full-Stack Web Developer & Machine Learning Enthusiast. Specializing in MERN Stack, Next.js, React Native, and Python. View my portfolio for top-tier web and mobile solutions."
  canonical="https://sheikhshariarnehal.me/"
  schema={[personSchema, websiteSchema, breadcrumbSchema, organizationSchema, faqSchema, localBusinessSchema]}
>
  <Header currentPage="home" />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="home" id="home" aria-labelledby="hero-heading">
      <div id="particles-js" aria-hidden="true"></div>

      <div class="content">
        <h1 id="hero-heading">{hero.greeting}<br /> I'm {hero.name.split(' ').slice(0, 2).join(' ')}<span> {hero.name.split(' ').slice(2).join(' ')}</span></h1>
        <p>{hero.subtitle} <span class="typing-text" aria-label="Various development skills"></span></p>
        <a href={hero.ctaLink} class="btn" aria-label={`Learn more - ${hero.ctaText}`}>
          <span>{hero.ctaText}</span>
          <i class="fas fa-arrow-circle-down" aria-hidden="true"></i>
        </a>
        <SocialIcons />
      </div>
      <div class="image">
        <Image
          draggable="false"
          class="tilt"
          src={hero.heroImage}
          alt={hero.heroImageAlt}
          width={500}
          height={500}
          sizes="(max-width: 768px) 60vw, 400px"
          loading="eager"
          decoding="async"
        />
      </div>
    </section>

  <!-- About Section -->
  <section class="about" id="about" aria-labelledby="about-heading">
    <h2 id="about-heading" class="heading"><i class="fas fa-user-alt" aria-hidden="true"></i> About <span>Me</span></h2>

    <div class="row">
      <div class="image">
        <img
          draggable="false"
          class="tilt"
          src={about.profileImage}
          alt={about.profileImageAlt}
          width={300}
          height={300}
          sizes="(max-width: 768px) 50vw, 300px"
          loading="eager"
          decoding="async"
        />
      </div>
      <div class="content">
        <h3>{about.title}</h3>
        <span class="tag">{about.subtitle}</span>

        <p>
          {about.bio}
        </p>

        <div class="box-container">
          <div class="box">
            <p><span>email : </span> {about.email}</p>
            <p><span>place : </span> {about.location}</p>
          </div>
        </div>

        <div class="resumebtn">
          <a
            href={about.resumeUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn"
          >
            <span>{about.resumeText}</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Skills Section -->
  <section class="skills" id="skills" aria-labelledby="skills-heading">
    <h2 id="skills-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Skills & <span>Abilities</span></h2>

    <div class="container">
      <div class="row" id="skillsContainer">
        {skills.map((skill) => <SkillCard name={skill.name} icon={skill.icon} />)}
      </div>
    </div>
  </section>

  <!-- Education Section -->
  <section class="education" id="education" aria-labelledby="education-heading">
    <h2 id="education-heading" class="heading"><i class="fas fa-graduation-cap" aria-hidden="true"></i> My <span>Education</span></h2>

    <p class="qoute">Education is not the learning of facts, but the training of the mind to think.</p>

    <div class="box-container">
      {education.map((edu) => (
        <EducationCard
          degree={edu.degree}
          institution={edu.institution}
          image={edu.image}
          duration={edu.duration}
          status={edu.status}
          altText={edu.altText}
        />
      ))}
    </div>
  </section>

  <!-- Projects Section -->
  <section class="work" id="work" aria-labelledby="projects-heading">
    <h2 id="projects-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Projects <span>Made</span></h2>

    <div class="box-container">
      {homeProjects.map((project) => (
        <div class="box tilt">
          <img
            draggable="false"
            src={`/assets/images/projects/${project.image}.webp`}
            alt={`${project.name} project`}
            width={350}
            height={200}
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 350px"
            loading="lazy"
          />
          <div class="content">
            <div class="tag">
              <h3>{project.name}</h3>
            </div>
            <div class="desc">
              <p>{project.desc}</p>
              <div class="btns">
                <a href={project.links.view} class="btn" target="_blank" rel="noopener noreferrer">
                  <i class="fas fa-eye"></i> View
                </a>
                <a href={project.links.code} class="btn" target="_blank" rel="noopener noreferrer">
                  Code <i class="fas fa-code"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="viewall">
      <a href="/projects" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Experience Section -->
  <section class="experience" id="experience" aria-labelledby="experience-heading">
    <h2 id="experience-heading" class="heading"><i class="fas fa-briefcase" aria-hidden="true"></i> Experience</h2>

    <div class="timeline">
      {homeExperience.map((exp) => (
        <TimelineItem
          organization={exp.organization}
          role={exp.role}
          duration={exp.duration}
          position={exp.position}
        />
      ))}
    </div>

    <div class="morebtn">
      <a href="/experience" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="contact" id="contact" aria-labelledby="contact-heading">
    <h2 id="contact-heading" class="heading"><i class="fas fa-headset" aria-hidden="true"></i> Get in <span>Touch</span></h2>

    <div class="container">
      <div class="content">
        <div class="image-box">
          <img
            draggable="false"
            src={contact.contactImage}
            alt={contact.contactImageAlt}
            width={400}
            height={400}
            sizes="(max-width: 768px) 80vw, 400px"
            loading="lazy"
          />
        </div>
        <ContactForm />
      </div>
    </div>
  </section>
  </main>

  <!-- FAQ Section for SEO -->
  <section class="faq-section" id="faq" aria-labelledby="faq-heading">
    <h2 id="faq-heading" class="heading"><i class="fas fa-question-circle" aria-hidden="true"></i> Frequently Asked <span>Questions</span></h2>
    <div class="faq-container">
      {defaultFAQs.map((faq, index) => (
        <details class="faq-item" open={index === 0}>
          <summary class="faq-question">
            <span>{faq.question}</span>
            <i class="fas fa-chevron-down faq-icon" aria-hidden="true"></i>
          </summary>
          <p class="faq-answer">{faq.answer}</p>
        </details>
      ))}
    </div>
  </section>

  <Footer />

  <!-- SEO Hidden Content -->
  <div style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
    <h2>Sheikh Shariar Nehal - Full Stack Web Developer & Machine Learning Engineer</h2>
    <p>Sheikh Shariar Nehal (Shariar Nehal) is a top-rated Full Stack Web Developer and Machine Learning enthusiast from Bangladesh.</p>
  </div>

  <!-- Scripts Slot -->
  <Fragment slot="scripts">
    <!-- Typed.js - Lazy loaded for better LCP -->
    <script define:vars={{ typingTexts: hero.typingTexts }}>
      function loadTypedJs() {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.5/typed.min.js';
        script.integrity = 'sha512-1KbKusm/hAtkX5FScVR5G36wodIMnVd/aP04af06iyQTkD17szAMGNmxfNH+tEuFp3Og/P5G32L1qEC47CZbUQ==';
        script.crossOrigin = 'anonymous';
        script.referrerPolicy = 'no-referrer';
        script.onload = () => {
          if (typeof Typed !== 'undefined') {
            new Typed('.typing-text', {
              strings: typingTexts,
              loop: true,
              typeSpeed: 50,
              backSpeed: 25,
              backDelay: 500,
            });
          }
        };
        document.body.appendChild(script);
      }
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadTypedJs, { timeout: 2000 });
      } else {
        setTimeout(loadTypedJs, 1500);
      }
    </script>

    <!-- Particles.js - Loaded after LCP to avoid blocking rendering -->
    <script is:inline>
      // Defer particles.js well past LCP to prevent layout thrashing
      function loadParticlesJs() {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js';
        script.integrity = 'sha512-Kef5sc7gfTacR7TZKelcrRs15ipf7+t+n7Zh6mKNJbmW+/RRdCW9nwfLn4YX0s2nO6Kv5Y2ChqgIakaC6PW09A==';
        script.crossOrigin = 'anonymous';
        script.referrerPolicy = 'no-referrer';
        script.onload = () => {
          if (typeof particlesJS !== 'undefined') {
            console.log('✨ Initializing particles.js...');
            particlesJS('particles-js', {
              particles: {
                number: {
                  value: 80,
                  density: {
                    enable: true,
                    value_area: 800,
                  },
                },
                color: {
                  value: '#3b5bdb',
                },
                shape: {
                  type: 'circle',
                },
                opacity: {
                  value: 0.6,
                  random: true,
                  anim: {
                    enable: true,
                    speed: 1,
                    opacity_min: 0.3,
                    sync: false,
                  },
                },
                size: {
                  value: 4,
                  random: true,
                  anim: {
                    enable: true,
                    speed: 2,
                    size_min: 0.5,
                    sync: false,
                  },
                },
                line_linked: {
                  enable: true,
                  distance: 150,
                  color: '#4c6ef5',
                  opacity: 0.5,
                  width: 1.5,
                },
                move: {
                  enable: true,
                  speed: 2,
                  direction: 'none',
                  random: false,
                  straight: false,
                  out_mode: 'out',
                  bounce: false,
                },
              },
              interactivity: {
                detect_on: 'canvas',
                events: {
                  onhover: {
                    enable: true,
                    mode: 'grab',
                  },
                  onclick: {
                    enable: true,
                    mode: 'push',
                  },
                  resize: true,
                },
                modes: {
                  grab: {
                    distance: 140,
                    line_linked: {
                      opacity: 1,
                    },
                  },
                  push: {
                    particles_nb: 4,
                  },
                },
              },
              retina_detect: true,
            });
            console.log('✅ Particles.js initialized successfully');
          } else {
            console.warn('⚠️ particlesJS is not defined');
          }
        };
        script.onerror = () => {
          console.error('❌ Failed to load particles.js library');
        };
        document.body.appendChild(script);
      }
      // Load particles after page load
      if (document.readyState === 'complete') {
        setTimeout(loadParticlesJs, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(loadParticlesJs, 1000);
        });
      }
    </script>

    <!-- Vanilla Tilt - Lazy loaded -->
    <script>
      // Lazy load Vanilla Tilt after page is interactive
      function loadVanillaTilt() {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js';
        script.integrity = 'sha512-SttpKhJqONuBVxbRcuH0wezjuX+BoFoli0yPsnrAADcHsQMW8rkR84ItFHGIkPvhnlRnE2FaifDOUw+EltbuHg==';
        script.crossOrigin = 'anonymous';
        script.referrerPolicy = 'no-referrer';
        script.onload = () => {
          if (typeof VanillaTilt !== 'undefined') {
            VanillaTilt.init(document.querySelectorAll('.tilt'), { max: 15 });
          }
        };
        document.body.appendChild(script);
      }

      // Delay VanillaTilt past LCP window
      setTimeout(loadVanillaTilt, 2500);
    </script>

    <!-- ScrollReveal - Lazy loaded to avoid forced reflows during initial paint -->
    <script>
      function loadScrollReveal() {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/scrollreveal@4.0.9/dist/scrollreveal.min.js';
        script.onload = () => {
          if (typeof ScrollReveal === 'undefined') return;
          const srtop = ScrollReveal({
            origin: 'top',
            distance: '80px',
            duration: 1000,
            reset: true
          });

          // Batch reveals to minimize reflows
          srtop.reveal('.home .content h3, .home .content p, .home .content .btn', { delay: 200 });
          srtop.reveal('.home .linkedin, .home .github, .home .twitter, .home .telegram, .home .instagram, .home .dev', { interval: 400 });
          srtop.reveal('.about .content h3, .about .content .tag, .about .content p, .about .content .box-container, .about .content .resumebtn', { delay: 200 });
          srtop.reveal('.skills .container', { interval: 200 });
          srtop.reveal('.education .box', { interval: 200 });
          srtop.reveal('.work .box', { interval: 200 });
          srtop.reveal('.experience .timeline', { delay: 400 });
          srtop.reveal('.experience .timeline .container', { interval: 400 });
          srtop.reveal('.contact .container', { delay: 400 });
        };
        document.body.appendChild(script);
      }

      // Delay ScrollReveal to avoid forced reflows during LCP window
      setTimeout(loadScrollReveal, 3000);
    </script>

    <!-- Main Script -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        // Scroll spy for navigation
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.navbar ul li a');
        
        let ticking = false;
        window.addEventListener('scroll', () => {
          if (!ticking) {
            requestAnimationFrame(() => {
              let current = '';
              sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 200) {
                  current = section.getAttribute('id') || '';
                }
              });

              navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href')?.includes(current)) {
                  link.classList.add('active');
                }
              });
              ticking = false;
            });
            ticking = true;
          }
        }, { passive: true });
      });

      // Tawk.to Live Chat - Lazy loaded
      let tawkLoaded = false;
      function loadTawk() {
        if (tawkLoaded) return;
        tawkLoaded = true;
        var s1 = document.createElement('script');
        s1.async = true;
        s1.src = 'https://embed.tawk.to/60df10bf7f4b000ac03ab6a8/1f9jlirg6';
        s1.charset = 'UTF-8';
        s1.setAttribute('crossorigin', '*');
        document.head.appendChild(s1);
      }

      window.addEventListener('load', () => {
        const loadOnInteraction = () => {
          loadTawk();
          ['scroll', 'click', 'touchstart', 'mousemove'].forEach(evt =>
            window.removeEventListener(evt, loadOnInteraction, { passive: true })
          );
        };
        ['scroll', 'click', 'touchstart', 'mousemove'].forEach(evt =>
          window.addEventListener(evt, loadOnInteraction, { passive: true, once: true })
        );
        setTimeout(loadTawk, 5000);
      });
    </script>
  </Fragment>
</Layout>
