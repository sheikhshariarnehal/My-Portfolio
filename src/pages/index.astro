---
import { Image } from 'astro:assets';
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SkillCard from '../components/SkillCard.astro';
import EducationCard from '../components/EducationCard.astro';
import TimelineItem from '../components/TimelineItem.astro';
import SocialIcons from '../components/SocialIcons.astro';
import ContactForm from '../components/ContactForm.astro';

import { getEducation, getExperience, getSkills, getHomepageSettings } from '../lib/supabase';
import { buildPersonSchema, buildWebsiteSchema, buildBreadcrumbSchema } from '../lib/schema';
import { buildSocialLinks, formatDateRange, splitName } from '../lib/helpers';
import { heroDefaults, aboutDefaults, contactDefaults, seoDefaults, SITE_URL } from '../data/site';

import skillsFallback from '../data/skills.json';
import projectsFallback from '../data/projects.json';

// --- Fetch all data in parallel with safe fallbacks ---
const [homepageSettings, educationData, experienceData, skillsData] = await Promise.all([
  getHomepageSettings().catch(() => ({})),
  getEducation(),
  getExperience(),
  getSkills(),
]);

// Hero uses only hardcoded defaults (no DB merge)
const hero = { ...heroDefaults };
const about = { ...aboutDefaults, ...homepageSettings.about };
const contact = { ...contactDefaults, ...homepageSettings.contact };
const seo = { ...seoDefaults, ...homepageSettings.seo };

// --- Transform data into view-ready shapes ---
const skills = skillsData?.length
  ? skillsData.map(({ name, icon }) => ({ name, icon }))
  : skillsFallback;

const education = educationData.map((edu) => ({
  degree: edu.degree,
  institution: edu.institution,
  image: edu.image || '/assets/images/educat/default.webp',
  duration: `${edu.start_year}-${edu.end_year || 'Present'}`,
  status: edu.status || 'Completed',
  altText: `${edu.institution} - ${edu.degree}`,
}));

const projects = projectsFallback
  .filter((p) => p.category !== 'android')
  .slice(0, 10);

const experience = experienceData.map((exp, i) => ({
  organization: exp.company,
  role: exp.title,
  duration: formatDateRange(exp.start_date, exp.end_date),
  position: (i % 2 === 0 ? 'left' : 'right') as 'left' | 'right',
}));

const { firstName, lastName } = splitName(hero.name);
const socialLinks = buildSocialLinks(seo);

// --- Structured data (JSON-LD) ---
const schemas = [
  buildPersonSchema(seo, about.profileImage),
  buildWebsiteSchema(seo),
  buildBreadcrumbSchema(),
];
---

<Layout
  title={`${seo.name} â€“ Full-Stack Developer`}
  description={seo.description}
  canonical={`${SITE_URL}/`}
  schema={schemas}
>
  <Header currentPage="home" />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="home" id="home" aria-labelledby="hero-heading">
      <div id="particles-js" aria-hidden="true"></div>

      <div class="content">
        <h1 id="hero-heading">{hero.greeting}<br /> I'm {firstName}<span> {lastName}</span></h1>
        <p>{hero.subtitle} <span class="typing-text" aria-label="Various development skills"></span></p>
        <a href={hero.ctaLink} class="btn" aria-label="Learn more about me">
          <span>{hero.ctaText}</span>
          <i class="fas fa-arrow-circle-down" aria-hidden="true"></i>
        </a>
        <SocialIcons socialLinks={socialLinks} />
      </div>
      <div class="image">
        <Image
          draggable="false"
          class="tilt"
          src={hero.heroImage}
          alt={hero.heroImageAlt}
          width={400}
          height={400}
          loading="eager"
        />
      </div>
    </section>

  <!-- About Section -->
  <section class="about" id="about" aria-labelledby="about-heading">
    <h2 id="about-heading" class="heading"><i class="fas fa-user-alt" aria-hidden="true"></i> About <span>Me</span></h2>

    <div class="row">
      <div class="image">
        <Image
          draggable="false"
          class="tilt"
          src={about.profileImage}
          alt={about.profileImageAlt}
          width={300}
          height={300}
          loading="lazy"
        />
      </div>
      <div class="content">
        <h3>{about.title}</h3>
        <span class="tag">{about.subtitle}</span>

        <p>{about.bio}</p>

        <div class="box-container">
          <div class="box">
            <p><span>email : </span> {about.email}</p>
            <p><span>place : </span> {about.location}</p>
          </div>
        </div>

        <div class="resumebtn">
          <a
            href={about.resumeUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn"
          >
            <span>{about.resumeText}</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Skills Section -->
  <section class="skills" id="skills" aria-labelledby="skills-heading">
    <h2 id="skills-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Skills & <span>Abilities</span></h2>

    <div class="container">
      <div class="row" id="skillsContainer">
        {skills.map((skill) => <SkillCard name={skill.name} icon={skill.icon} />)}
      </div>
    </div>
  </section>

  <!-- Education Section -->
  <section class="education" id="education" aria-labelledby="education-heading">
    <h2 id="education-heading" class="heading"><i class="fas fa-graduation-cap" aria-hidden="true"></i> My <span>Education</span></h2>

    <p class="qoute">Education is not the learning of facts, but the training of the mind to think.</p>

    <div class="box-container">
      {education.map((edu) => (
        <EducationCard
          degree={edu.degree}
          institution={edu.institution}
          image={edu.image}
          duration={edu.duration}
          status={edu.status}
          altText={edu.altText}
        />
      ))}
    </div>
  </section>

  <!-- Projects Section -->
  <section class="work" id="work" aria-labelledby="projects-heading">
    <h2 id="projects-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Projects <span>Made</span></h2>

    <div class="box-container">
      {projects.map((project) => (
        <div class="box tilt">
          <Image
            draggable="false"
            src={`/assets/images/projects/${project.image}.webp`}
            alt={`${project.name} project`}
            width={350}
            height={200}
            loading="lazy"
          />
          <div class="content">
            <div class="tag">
              <h3>{project.name}</h3>
            </div>
            <div class="desc">
              <p>{project.desc}</p>
              <div class="btns">
                <a href={project.links.view} class="btn" target="_blank" rel="noopener noreferrer">
                  <i class="fas fa-eye"></i> View
                </a>
                <a href={project.links.code} class="btn" target="_blank" rel="noopener noreferrer">
                  Code <i class="fas fa-code"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="viewall">
      <a href="/projects" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Experience Section -->
  <section class="experience" id="experience" aria-labelledby="experience-heading">
    <h2 id="experience-heading" class="heading"><i class="fas fa-briefcase" aria-hidden="true"></i> Experience</h2>

    <div class="timeline">
      {experience.map((exp) => (
        <TimelineItem
          organization={exp.organization}
          role={exp.role}
          duration={exp.duration}
          position={exp.position}
        />
      ))}
    </div>

    <div class="morebtn">
      <a href="/experience" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="contact" id="contact" aria-labelledby="contact-heading">
    <h2 id="contact-heading" class="heading"><i class="fas fa-headset" aria-hidden="true"></i> Get in <span>Touch</span></h2>

    <div class="container">
      <div class="content">
        <div class="image-box">
          <Image
            draggable="false"
            src={contact.contactImage}
            alt={contact.contactImageAlt}
            width={400}
            height={400}
            loading="lazy"
          />
        </div>
        <ContactForm />
      </div>
    </div>
  </section>
  </main>

  <Footer socialLinks={socialLinks} />

  <!-- Typing Texts Data (for Typed.js) -->
  <script type="application/json" id="typing-data" set:html={JSON.stringify(hero.typingTexts)}></script>

  <!-- Scripts Slot -->
  <Fragment slot="scripts">
    <!-- Typed.js -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.5/typed.min.js" integrity="sha512-1KbKusm/hAtkX5FScVR5G36wodIMnVd/aP04af06iyQTkD17szAMGNmxfNH+tEuFp3Og/P5G32L1qEC47CZbUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Particles.js - Lazy loaded after main content for better LCP -->
    <script is:inline>
      (function () {
        // Skip entirely if user prefers reduced motion
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

        function loadParticles() {
          var lib = document.createElement('script');
          lib.src = '/assets/js/particles.min.js';
          lib.onerror = function () { console.warn('particles.js failed to load'); };
          lib.onload = function () {
            var cfg = document.createElement('script');
            cfg.src = '/assets/js/app.js';
            document.body.appendChild(cfg);
          };
          document.body.appendChild(lib);
        }

        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadParticles);
        } else {
          setTimeout(loadParticles, 1500);
        }
      })();
    </script>

    <!-- Vanilla Tilt -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js" integrity="sha512-SttpKhJqONuBVxbRcuH0wezjuX+BoFoli0yPsnrAADcHsQMW8rkR84ItFHGIkPvhnlRnE2FaifDOUw+EltbuHg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- ScrollReveal -->
    <script defer src="https://unpkg.com/scrollreveal@4.0.9/dist/scrollreveal.min.js"></script>

    <!-- Main Script -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        // Typed.js effect
        if (typeof Typed !== 'undefined') {
          new Typed('.typing-text', {
            strings: JSON.parse(document.getElementById('typing-data')?.textContent || '[]'),
            loop: true,
            typeSpeed: 50,
            backSpeed: 25,
            backDelay: 500,
          });
        }

        // Vanilla Tilt
        if (typeof VanillaTilt !== 'undefined') {
          VanillaTilt.init(document.querySelectorAll('.tilt'), {
            max: 15,
          });
        }

        // ScrollReveal
        if (typeof ScrollReveal !== 'undefined') {
          const srtop = ScrollReveal({
            origin: 'top',
            distance: '80px',
            duration: 1000,
            reset: true
          });

          srtop.reveal('.home .content h3', { delay: 200 });
          srtop.reveal('.home .content p', { delay: 200 });
          srtop.reveal('.home .content .btn', { delay: 200 });
          // Hero image excluded from ScrollReveal to prevent reload animation effect
          srtop.reveal('.home .linkedin', { interval: 600 });
          srtop.reveal('.home .github', { interval: 800 });
          srtop.reveal('.home .twitter', { interval: 1000 });
          srtop.reveal('.home .telegram', { interval: 600 });
          srtop.reveal('.home .instagram', { interval: 600 });
          srtop.reveal('.home .dev', { interval: 600 });
          srtop.reveal('.about .content h3', { delay: 200 });
          srtop.reveal('.about .content .tag', { delay: 200 });
          srtop.reveal('.about .content p', { delay: 200 });
          srtop.reveal('.about .content .box-container', { delay: 200 });
          srtop.reveal('.about .content .resumebtn', { delay: 200 });
          srtop.reveal('.skills .container', { interval: 200 });
          srtop.reveal('.skills .container .bar', { delay: 400 });
          srtop.reveal('.education .box', { interval: 200 });
          srtop.reveal('.work .box', { interval: 200 });
          srtop.reveal('.experience .timeline', { delay: 400 });
          srtop.reveal('.experience .timeline .container', { interval: 400 });
          srtop.reveal('.contact .container', { delay: 400 });
          srtop.reveal('.contact .container .form-group', { delay: 400 });
        }

        // Scroll spy for navigation
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.navbar ul li a');
        
        window.addEventListener('scroll', () => {
          let current = '';
          sections.forEach(section => {
            if (scrollY >= section.offsetTop - 200) {
              current = section.getAttribute('id') || '';
            }
          });

          navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href')?.includes(current)) {
              link.classList.add('active');
            }
          });
        });
      });

      // Tawk.to Live Chat - Lazy loaded on first interaction or after 5s
      (function initTawk() {
        let loaded = false;
        const TAWK_SRC = 'https://embed.tawk.to/60df10bf7f4b000ac03ab6a8/1f9jlirg6';
        const INTERACTION_EVENTS = ['scroll', 'click', 'touchstart', 'mousemove'];

        function load() {
          if (loaded) return;
          loaded = true;
          const s = document.createElement('script');
          s.async = true;
          s.src = TAWK_SRC;
          s.charset = 'UTF-8';
          s.setAttribute('crossorigin', '*');
          document.head.appendChild(s);
          INTERACTION_EVENTS.forEach(e => window.removeEventListener(e, load));
        }

        INTERACTION_EVENTS.forEach(e =>
          window.addEventListener(e, load, { passive: true, once: true })
        );
        setTimeout(load, 5000);
      })();
    </script>
  </Fragment>
</Layout>
