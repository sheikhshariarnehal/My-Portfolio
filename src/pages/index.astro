---
import { Image } from 'astro:assets';
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SkillCard from '../components/SkillCard.astro';
import EducationCard from '../components/EducationCard.astro';
import TimelineItem from '../components/TimelineItem.astro';
import SocialIcons from '../components/SocialIcons.astro';
import ContactForm from '../components/ContactForm.astro';
import { getEducation, getExperience, getSkills, getHomepageSettings } from '../lib/supabase';

// ============ HARDCODED DEFAULTS (fallback if DB is empty) ============
const DEFAULTS = {
  hero: {
    greeting: 'Hi There,',
    name: 'Sheikh Shariar Nehal',
    subtitle: 'I Am Into',
    ctaText: 'About Me',
    ctaLink: '#about',
    heroImage: '/assets/images/hero.webp',
    heroImageAlt: 'Sheikh Shariar Nehal - Full Stack Web Developer',
    typingTexts: ['frontend development', 'backend development', 'web designing', 'android development', 'web development'],
  },
  about: {
    title: "I'm Sheikh Shariar Nehal",
    subtitle: 'Web Developer',
    bio: "I'm Sheikh Shariar Nehal (also known as Shariar Nehal or Sheikh Nehal), a Web Developer and programmer with 3 years of experience. Currently studying B.Sc. in Computer Science and Engineering at Daffodil International University. I know React, Python, JavaScript, and C++, I also good with design tools like Photoshop and Illustrator. I helped create a web app that increased user activity by 40%. I'm detail-oriented and love combining design with tech.",
    email: 'nehal22205101260@diu.edu.bd',
    location: 'Nowabgonj, Dhaka',
    resumeUrl: 'https://drive.google.com/file/d/1Bs5evFnBecp1zvVXqpe7FglHCZ9EQIKy/view',
    resumeText: 'Resume',
    profileImage: '/assets/images/profile2.webp',
    profileImageAlt: 'Sheikh Shariar Nehal Profile Picture - Web Developer and Designer',
  },
  contact: {
    contactImage: '/assets/images/contact1.webp',
    contactImageAlt: 'Contact Sheikh Shariar Nehal - Get In Touch',
  },
  seo: {
    name: 'Sheikh Shariar Nehal',
    jobTitle: 'Full-Stack Web Developer & Designer',
    description: 'Sheikh Shariar Nehal is a Full-Stack Web Developer with 3+ years of experience specializing in React, Next.js, Python, and JavaScript.',
    email: 'nehal22205101260@diu.edu.bd',
    telephone: '+8801750627421',
    nationality: 'Bangladesh',
    addressLocality: 'Nowabgonj',
    addressRegion: 'Dhaka',
    addressCountry: 'BD',
    university: 'Daffodil International University',
    universityUrl: 'https://daffodilvarsity.edu.bd',
    github: 'https://github.com/sheikhshariarnehal',
    linkedin: 'https://www.linkedin.com/in/shekhshariarnehal/',
    twitter: 'https://twitter.com/shariar_nehal',
    telegram: 'https://t.me/sheikhshariarnehal',
    instagram: 'https://instagram.com/sheikhshariarnehal',
    facebook: 'https://www.facebook.com/sheikhshariarnehal.cse',
  },
};

// ============ FETCH DATA FROM DB (with safe fallbacks) ============
const [homepageSettings, educationData, experienceData, skillsData] = await Promise.all([
  getHomepageSettings().catch(() => ({})),
  getEducation(),
  getExperience(),
  getSkills(),
]);

// Merge DB data over defaults – every field has a guaranteed fallback
const hero = {
  ...DEFAULTS.hero,
  ...homepageSettings.hero,
  // Always use static hero image for faster load (override DB value)
  heroImage: '/assets/images/hero.webp',
  heroImageAlt: homepageSettings.hero?.heroImageAlt || DEFAULTS.hero.heroImageAlt
};
const about = { ...DEFAULTS.about, ...homepageSettings.about };
const contact = { ...DEFAULTS.contact, ...homepageSettings.contact };
const seo = { ...DEFAULTS.seo, ...homepageSettings.seo };

// Skills: use DB if available, else fall back to JSON file
import skillsFallback from '../data/skills.json';
const skills = skillsData && skillsData.length > 0
  ? skillsData.map(s => ({ name: s.name, icon: s.icon }))
  : skillsFallback;

// Education
const education = educationData.map(edu => ({
  degree: edu.degree,
  institution: edu.institution,
  image: edu.image || '/assets/images/educat/default.webp',
  duration: `${edu.start_year}-${edu.end_year || 'Present'}`,
  status: edu.status || 'Completed',
  altText: `${edu.institution} - ${edu.degree}`
}));

// Projects: still from DB via getProjects or JSON fallback for homepage
import projectsFallback from '../data/projects.json';
const homeProjects = projectsFallback.filter(p => p.category !== 'android').slice(0, 10);

// Experience
const homeExperience = experienceData.map((exp, index) => {
  const startDate = new Date(exp.start_date);
  const endDate = exp.end_date ? new Date(exp.end_date) : null;
  const startStr = startDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  const endStr = endDate ? endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'Present';
  
  return {
    organization: exp.company,
    role: exp.title,
    duration: `${startStr} - ${endStr}`,
    position: (index % 2 === 0 ? 'left' : 'right') as 'left' | 'right'
  };
});

// Build name parts for hero heading
const nameParts = hero.name.split(' ');
const lastName = nameParts.pop() || '';
const firstName = nameParts.join(' ');

// Collect social links from SEO data for SocialIcons
const socialLinks = [
  seo.linkedin ? { href: seo.linkedin, icon: 'fab fa-linkedin', label: 'LinkedIn', className: 'linkedin' } : null,
  seo.github ? { href: seo.github, icon: 'fab fa-github', label: 'GitHub', className: 'github' } : null,
  seo.twitter ? { href: seo.twitter, icon: 'fab fa-twitter', label: 'Twitter', className: 'twitter' } : null,
  seo.telegram ? { href: seo.telegram, icon: 'fab fa-telegram-plane', label: 'Telegram', className: 'telegram' } : null,
  seo.instagram ? { href: seo.instagram, icon: 'fab fa-instagram', label: 'Instagram', className: 'instagram' } : null,
  seo.facebook ? { href: seo.facebook, icon: 'fab fa-facebook', plane: true, label: 'Facebook', className: 'dev' } : null,
].filter(Boolean);

// Schema.org JSON-LD - Enhanced Person Schema (uses DB data)
const personSchema = {
  "@context": "https://schema.org",
  "@type": "Person",
  "@id": "https://sheikhshariarnehal.me/#person",
  "name": seo.name,
  "alternateName": ["Shariar Nehal", "Sheikh Nehal", "Nehal"],
  "givenName": seo.name.split(' ').slice(0, -1).join(' '),
  "familyName": seo.name.split(' ').pop(),
  "url": "https://sheikhshariarnehal.me",
  "image": {
    "@type": "ImageObject",
    "url": "https://sheikhshariarnehal.me" + about.profileImage,
    "width": 400,
    "height": 400
  },
  "jobTitle": seo.jobTitle,
  "description": seo.description,
  "email": seo.email,
  "telephone": seo.telephone,
  "nationality": {
    "@type": "Country",
    "name": seo.nationality
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": seo.addressLocality,
    "addressRegion": seo.addressRegion,
    "addressCountry": seo.addressCountry
  },
  "alumniOf": {
    "@type": "EducationalOrganization",
    "name": seo.university,
    "url": seo.universityUrl
  },
  "knowsAbout": [
    "React.js", "Next.js", "Node.js", "TypeScript", "JavaScript", "Python",
    "MERN Stack", "Full Stack Development", "Machine Learning", "Web Design",
    "REST APIs", "PostgreSQL", "MongoDB", "Supabase", "Firebase"
  ],
  "knowsLanguage": ["en", "bn"],
  "worksFor": {
    "@type": "Organization",
    "name": "Freelance"
  },
  "sameAs": [
    seo.github,
    seo.linkedin,
    seo.twitter,
    seo.telegram,
    seo.instagram,
    seo.facebook
  ].filter(Boolean)
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": "https://sheikhshariarnehal.me/#website",
  "name": `${seo.name} Portfolio`,
  "alternateName": "Shariar Nehal Portfolio",
  "url": "https://sheikhshariarnehal.me",
  "description": `Portfolio website of ${seo.name} showcasing web development projects, skills, and professional experience`,
  "publisher": {
    "@id": "https://sheikhshariarnehal.me/#person"
  },
  "inLanguage": "en-US",
  "copyrightYear": new Date().getFullYear(),
  "copyrightHolder": {
    "@id": "https://sheikhshariarnehal.me/#person"
  }
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://sheikhshariarnehal.me/" },
    { "@type": "ListItem", "position": 2, "name": "Projects", "item": "https://sheikhshariarnehal.me/projects/" },
    { "@type": "ListItem", "position": 3, "name": "Experience", "item": "https://sheikhshariarnehal.me/experience/" }
  ]
};
---

<Layout
  title={`${seo.name} – Full-Stack Developer`}
  description={seo.description}
  canonical="https://sheikhshariarnehal.me/"
  schema={[personSchema, websiteSchema, breadcrumbSchema]}
>
  <Header currentPage="home" />

  <main id="main-content">
    <!-- Hero Section -->
    <section class="home" id="home" aria-labelledby="hero-heading">
      <div id="particles-js" aria-hidden="true"></div>

    <div class="content">
      <h1 id="hero-heading">{hero.greeting}<br /> I'm {firstName}<span> {lastName}</span></h1>
      <p>{hero.subtitle} <span class="typing-text" aria-label="Various development skills"></span></p>
      <a href={hero.ctaLink} class="btn" aria-label="Learn more about me">
        <span>{hero.ctaText}</span>
        <i class="fas fa-arrow-circle-down" aria-hidden="true"></i>
      </a>
      <SocialIcons />
    </div>
    <div class="image">
      <Image
        draggable="false"
        class="tilt"
        src={hero.heroImage}
        alt={hero.heroImageAlt}
        width={400}
        height={400}
        loading="eager"
      />
    </div>
  </section>

  <!-- About Section -->
  <section class="about" id="about" aria-labelledby="about-heading">
    <h2 id="about-heading" class="heading"><i class="fas fa-user-alt" aria-hidden="true"></i> About <span>Me</span></h2>

    <div class="row">
      <div class="image">
        <Image
          draggable="false"
          class="tilt"
          src={about.profileImage}
          alt={about.profileImageAlt}
          width={300}
          height={300}
          loading="lazy"
        />
      </div>
      <div class="content">
        <h3>{about.title}</h3>
        <span class="tag">{about.subtitle}</span>

        <p>{about.bio}</p>

        <div class="box-container">
          <div class="box">
            <p><span>email : </span> {about.email}</p>
            <p><span>place : </span> {about.location}</p>
          </div>
        </div>

        <div class="resumebtn">
          <a
            href={about.resumeUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="btn"
          >
            <span>{about.resumeText}</span>
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Skills Section -->
  <section class="skills" id="skills" aria-labelledby="skills-heading">
    <h2 id="skills-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Skills & <span>Abilities</span></h2>

    <div class="container">
      <div class="row" id="skillsContainer">
        {skills.map((skill) => <SkillCard name={skill.name} icon={skill.icon} />)}
      </div>
    </div>
  </section>

  <!-- Education Section -->
  <section class="education" id="education" aria-labelledby="education-heading">
    <h2 id="education-heading" class="heading"><i class="fas fa-graduation-cap" aria-hidden="true"></i> My <span>Education</span></h2>

    <p class="qoute">Education is not the learning of facts, but the training of the mind to think.</p>

    <div class="box-container">
      {education.map((edu) => (
        <EducationCard
          degree={edu.degree}
          institution={edu.institution}
          image={edu.image}
          duration={edu.duration}
          status={edu.status}
          altText={edu.altText}
        />
      ))}
    </div>
  </section>

  <!-- Projects Section -->
  <section class="work" id="work" aria-labelledby="projects-heading">
    <h2 id="projects-heading" class="heading"><i class="fas fa-laptop-code" aria-hidden="true"></i> Projects <span>Made</span></h2>

    <div class="box-container">
      {homeProjects.map((project) => (
        <div class="box tilt">
          <Image
            draggable="false"
            src={`/assets/images/projects/${project.image}.webp`}
            alt={`${project.name} project`}
            width={350}
            height={200}
            loading="lazy"
          />
          <div class="content">
            <div class="tag">
              <h3>{project.name}</h3>
            </div>
            <div class="desc">
              <p>{project.desc}</p>
              <div class="btns">
                <a href={project.links.view} class="btn" target="_blank" rel="noopener noreferrer">
                  <i class="fas fa-eye"></i> View
                </a>
                <a href={project.links.code} class="btn" target="_blank" rel="noopener noreferrer">
                  Code <i class="fas fa-code"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="viewall">
      <a href="/projects" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Experience Section -->
  <section class="experience" id="experience" aria-labelledby="experience-heading">
    <h2 id="experience-heading" class="heading"><i class="fas fa-briefcase" aria-hidden="true"></i> Experience</h2>

    <div class="timeline">
      {homeExperience.map((exp) => (
        <TimelineItem
          organization={exp.organization}
          role={exp.role}
          duration={exp.duration}
          position={exp.position}
        />
      ))}
    </div>

    <div class="morebtn">
      <a href="/experience" class="btn">
        <span>View All</span>
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </section>

  <!-- Contact Section -->
  <section class="contact" id="contact" aria-labelledby="contact-heading">
    <h2 id="contact-heading" class="heading"><i class="fas fa-headset" aria-hidden="true"></i> Get in <span>Touch</span></h2>

    <div class="container">
      <div class="content">
        <div class="image-box">
          <Image
            draggable="false"
            src={contact.contactImage}
            alt={contact.contactImageAlt}
            width={400}
            height={400}
            loading="lazy"
          />
        </div>
        <ContactForm />
      </div>
    </div>
  </section>
  </main>

  <Footer />

  <!-- SEO Hidden Content -->
  <div style="position: absolute; left: -9999px; width: 1px; height: 1px; overflow: hidden;">
    <h2>{seo.name} - {seo.jobTitle}</h2>
    <p>{seo.description}</p>
  </div>

  <!-- Typing Texts Data (for Typed.js) -->
  <script type="application/json" id="typing-data" set:html={JSON.stringify(hero.typingTexts)}></script>

  <!-- Scripts Slot -->
  <Fragment slot="scripts">
    <!-- Typed.js -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.5/typed.min.js" integrity="sha512-1KbKusm/hAtkX5FScVR5G36wodIMnVd/aP04af06iyQTkD17szAMGNmxfNH+tEuFp3Og/P5G32L1qEC47CZbUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Particles.js - Lazy loaded for better LCP -->
    <script is:inline>
      // Lazy load particles.js after page becomes interactive
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => loadParticles());
      } else {
        setTimeout(loadParticles, 1500);
      }
      
      function loadParticles() {
        const script = document.createElement('script');
        script.src = '/assets/js/particles.min.js';
        script.onload = () => {
          const appScript = document.createElement('script');
          appScript.src = '/assets/js/app.js';
          document.body.appendChild(appScript);
        };
        document.body.appendChild(script);
      }
    </script>

    <!-- Vanilla Tilt -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js" integrity="sha512-SttpKhJqONuBVxbRcuH0wezjuX+BoFoli0yPsnrAADcHsQMW8rkR84ItFHGIkPvhnlRnE2FaifDOUw+EltbuHg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- ScrollReveal -->
    <script defer src="https://unpkg.com/scrollreveal@4.0.9/dist/scrollreveal.min.js"></script>

    <!-- Main Script -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        // Typed.js effect
        if (typeof Typed !== 'undefined') {
          new Typed('.typing-text', {
            strings: JSON.parse(document.getElementById('typing-data')?.textContent || '[]'),
            loop: true,
            typeSpeed: 50,
            backSpeed: 25,
            backDelay: 500,
          });
        }

        // Vanilla Tilt
        if (typeof VanillaTilt !== 'undefined') {
          VanillaTilt.init(document.querySelectorAll('.tilt'), {
            max: 15,
          });
        }

        // ScrollReveal
        if (typeof ScrollReveal !== 'undefined') {
          const srtop = ScrollReveal({
            origin: 'top',
            distance: '80px',
            duration: 1000,
            reset: true
          });

          srtop.reveal('.home .content h3', { delay: 200 });
          srtop.reveal('.home .content p', { delay: 200 });
          srtop.reveal('.home .content .btn', { delay: 200 });
          // Hero image excluded from ScrollReveal to prevent reload animation effect
          srtop.reveal('.home .linkedin', { interval: 600 });
          srtop.reveal('.home .github', { interval: 800 });
          srtop.reveal('.home .twitter', { interval: 1000 });
          srtop.reveal('.home .telegram', { interval: 600 });
          srtop.reveal('.home .instagram', { interval: 600 });
          srtop.reveal('.home .dev', { interval: 600 });
          srtop.reveal('.about .content h3', { delay: 200 });
          srtop.reveal('.about .content .tag', { delay: 200 });
          srtop.reveal('.about .content p', { delay: 200 });
          srtop.reveal('.about .content .box-container', { delay: 200 });
          srtop.reveal('.about .content .resumebtn', { delay: 200 });
          srtop.reveal('.skills .container', { interval: 200 });
          srtop.reveal('.skills .container .bar', { delay: 400 });
          srtop.reveal('.education .box', { interval: 200 });
          srtop.reveal('.work .box', { interval: 200 });
          srtop.reveal('.experience .timeline', { delay: 400 });
          srtop.reveal('.experience .timeline .container', { interval: 400 });
          srtop.reveal('.contact .container', { delay: 400 });
          srtop.reveal('.contact .container .form-group', { delay: 400 });
        }

        // Scroll spy for navigation
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('.navbar ul li a');
        
        window.addEventListener('scroll', () => {
          let current = '';
          sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (scrollY >= sectionTop - 200) {
              current = section.getAttribute('id') || '';
            }
          });

          navLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href')?.includes(current)) {
              link.classList.add('active');
            }
          });
        });
      });

      // Tawk.to Live Chat - Lazy loaded
      let tawkLoaded = false;
      function loadTawk() {
        if (tawkLoaded) return;
        tawkLoaded = true;
        var s1 = document.createElement('script');
        s1.async = true;
        s1.src = 'https://embed.tawk.to/60df10bf7f4b000ac03ab6a8/1f9jlirg6';
        s1.charset = 'UTF-8';
        s1.setAttribute('crossorigin', '*');
        document.head.appendChild(s1);
      }

      window.addEventListener('load', () => {
        const loadOnInteraction = () => {
          loadTawk();
          ['scroll', 'click', 'touchstart', 'mousemove'].forEach(evt =>
            window.removeEventListener(evt, loadOnInteraction, { passive: true })
          );
        };
        ['scroll', 'click', 'touchstart', 'mousemove'].forEach(evt =>
          window.addEventListener(evt, loadOnInteraction, { passive: true, once: true })
        );
        setTimeout(loadTawk, 5000);
      });
    </script>
  </Fragment>
</Layout>
